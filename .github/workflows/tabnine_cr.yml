name: Tabnine Code Review
on:
  pull_request

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          
      - name: Install Tabnine CLI
        run: |
          export TABNINE_HOST=https://console.tabnine.com
          curl $TABNINE_HOST/update/cli/installer.mjs | node - $TABNINE_HOST
          
      - name: Configure git
        run: |
          git config user.name "Tabnine CLI Agent"
          git config user.email "TabnineCLI@tabnine.com"

      - name: Configure tabnine auth
        run: |
          mkdir -p ~/.tabnine/agent
          echo ${{ secrets.TABNINE_KEY }} > ~/.tabnine/agent/tabnine_creds.json
          
      - name: Code Review
        env:
          GH_TOKEN: ${{ github.token }}
        run: ~/.local/bin/tabnine -y --output-format json -p "You are operating in a GitHub Actions runner performing automated code review. The gh CLI is available and authenticated via GH_TOKEN. You may comment on pull requests."
